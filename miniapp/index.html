<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>GROO Reports</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg0:#0d2550;
      --bg1:#153971;
      --panel:rgba(255,255,255,.12);
      --panel2:rgba(255,255,255,.18);
      --border:rgba(170,220,255,.28);
      --text:#F4F8FF;
      --muted:rgba(232,243,255,.78);
      --navy:#0b1730;
      --green:#0b3b2a;
      --violet:#6a63ff;
      --accent:#35f0d2;
      --glowG: rgba(53, 240, 210, .28);
      --glowV: rgba(142, 114, 255, .24);
      --glowB: rgba(96, 190, 255, .28);
      --tile-icon-tone: rgba(236,249,255,.86);
      --r16:16px;
      --r18:18px;
      --r22:22px;
      --r24:24px;
      
      /* Safe area –¥–ª—è iOS */
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-left: env(safe-area-inset-left);
      --safe-right: env(safe-area-inset-right);
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; overflow-x:hidden; }
    body{
      color:var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', ui-sans-serif, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1100px 700px at 12% 8%, rgba(130,110,255,.30), transparent 62%),
        radial-gradient(980px 660px at 88% 16%, rgba(53,240,210,.24), transparent 58%),
        radial-gradient(1050px 760px at 50% 108%, rgba(124,205,255,.24), transparent 65%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior: none;
      touch-action: pan-y;
    }

    /* Background layers */
    .bg-geo{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:0;
      opacity:.9;
    }
    .bg-geo::before{
      content:"";
      position:absolute; inset:-20%;
      background:
        repeating-linear-gradient(135deg, rgba(215,238,255,.08) 0 1px, transparent 1px 18px),
        repeating-linear-gradient(45deg, rgba(170,223,255,.05) 0 1px, transparent 1px 22px);
      filter: blur(.2px);
      transform: rotate(-6deg);
      opacity:.42;
    }
    .bg-geo::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 560px at 20% 30%, rgba(53,240,210,.20), transparent 60%),
        radial-gradient(860px 620px at 80% 40%, rgba(130,110,255,.22), transparent 60%),
        radial-gradient(1100px 760px at 50% 110%, rgba(216,240,255,.14), transparent 70%);
      opacity:.7;
    }
    .noise{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:0;
      opacity:.06;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
    }

    /* Netflix intro */
    .intro{
      position:fixed; inset:0;
      z-index:9999;
      background:
        radial-gradient(900px 560px at 16% 8%, rgba(14,47,38,.54), transparent 64%),
        radial-gradient(880px 620px at 84% 12%, rgba(13,36,61,.52), transparent 66%),
        linear-gradient(180deg, #0d1f2b, #071016);
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .intro .logo{
      font-weight:900;
      letter-spacing:.18em;
      font-size:46px;
      opacity:0;
      transform: translateY(12px);
      filter: blur(10px);
      animation: introLogo 900ms ease forwards;
      color: transparent;
      background: linear-gradient(170deg, rgba(255,255,255,.95), rgba(194,220,234,.78), rgba(245,250,253,.92));
      -webkit-background-clip: text;
      background-clip: text;
      text-shadow:
        0 1px 0 rgba(255,255,255,.35),
        0 14px 24px rgba(0,0,0,.46);
    }
    .intro .bar{
      position:absolute;
      left:-120%;
      top:58%;
      width:140%;
      height:7px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
      filter: blur(.3px);
      animation: introBar 900ms ease forwards;
    }
    .intro .fade{
      position:absolute; inset:0;
      background: radial-gradient(700px 500px at 50% 40%, rgba(92,59,255,.16), transparent 60%);
      opacity:0;
      animation: introGlow 900ms ease forwards;
    }
    @keyframes introLogo{
      0%{ opacity:0; transform:translateY(12px); filter: blur(10px); }
      55%{ opacity:1; transform:translateY(0); filter: blur(0); }
      100%{ opacity:1; }
    }
    @keyframes introBar{
      0%{ transform: translateX(0); opacity:.55; }
      100%{ transform: translateX(220%); opacity:0; }
    }
    @keyframes introGlow{
      0%{ opacity:0; }
      55%{ opacity:1; }
      100%{ opacity:.25; }
    }
    .hidden{ display:none; }

    /* Layout */
    .wrap{
      position:relative;
      z-index:1;
      max-width:640px;
      margin:0 auto;
      padding: calc(14px + var(--safe-top)) 16px calc(28px + var(--safe-bottom));
      min-height: 100vh;
    }

    /* Header card */
    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(234,247,255,.22), rgba(196,232,255,.10));
      border-radius: var(--r24);
      box-shadow:
        0 24px 60px rgba(3,18,44,.36),
        0 0 0 1px rgba(255,255,255,.08) inset;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .top{
      padding:18px 20px;
      display:flex;
      gap:14px;
      align-items:center;
    }
    .avatar{
      width:52px; height:52px; border-radius:50%;
      border:2px solid rgba(0,255,170,.3);
      background:
        radial-gradient(26px 26px at 35% 30%, rgba(0,255,170,.28), transparent 60%),
        radial-gradient(26px 26px at 70% 65%, rgba(92,59,255,.30), transparent 62%),
        rgba(255,255,255,.07);
      box-shadow: 
        0 0 30px rgba(0,255,170,.12),
        0 0 0 3px rgba(0,255,170,.08);
      flex:0 0 auto;
      display:grid;
      place-items:center;
      font-weight:800;
      font-size:18px;
      color:rgba(234,240,255,.95);
      letter-spacing:.02em;
      overflow:hidden;
      position:relative;
    }
    .avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:50%;
      display:block;
    }
    .user-info{
      flex:1;
      min-width:0;
    }
    .title{
      font-size:17px;
      font-weight:700;
      letter-spacing:-.01em;
      margin-bottom:3px;
    }
    .sub{
      font-size:13px;
      color:var(--muted);
      opacity:.85;
    }

    .access{
      margin: 14px 20px 20px;
      padding: 14px 16px;
      border-radius: var(--r18);
      border: 1px solid rgba(180,225,255,.26);
      background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(171,230,255,.08));
      display:flex;
      gap:12px;
      align-items:center;
    }
    .access-icon{
      width:36px;
      height:36px;
      border-radius:10px;
      background: rgba(255,255,255,.08);
      display:grid;
      place-items:center;
      font-size:18px;
      flex-shrink:0;
    }
    .access-text{
      flex:1;
      min-width:0;
    }
    .access-msg{
      font-size:13px;
      color: rgba(234,240,255,.85);
      line-height:1.4;
    }
    .badge{
      margin-left:auto;
      font-size:11px;
      font-weight:600;
      padding:6px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(234,240,255,.90);
      letter-spacing:.02em;
      text-transform:uppercase;
      flex-shrink:0;
    }
    .badge.ok{
      border-color: rgba(0,255,170,.30);
      background: rgba(0,255,170,.12);
      color: #00ffaa;
      box-shadow: 0 0 0 1px rgba(0,255,170,.10) inset, 0 0 20px rgba(0,255,170,.10);
    }
    .badge.no{
      border-color: rgba(255,120,120,.30);
      background: rgba(255,120,120,.12);
      color: #ff9999;
      box-shadow: 0 0 0 1px rgba(255,120,120,.10) inset;
    }

    /* Reports grid */
    .section-title{
      font-size:14px;
      font-weight:700;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
      margin:32px 0 16px 4px;
    }
    
    .menu{
      display:grid;
      gap:12px;
      margin-bottom:20px;
    }
    
    .tile{
      position:relative;
      border:1px solid rgba(177,224,255,.34);
      border-radius: var(--r22);
      background:
        radial-gradient(900px 220px at 30% -20%, rgba(53,240,210,.18), transparent 65%),
        radial-gradient(900px 220px at 70% -10%, rgba(130,110,255,.20), transparent 65%),
        linear-gradient(140deg, rgba(232,246,255,.20), rgba(176,219,255,.11));
      padding: 18px 20px;
      display:flex;
      align-items:center;
      gap:14px;
      cursor:pointer;
      user-select:none;
      transition: all .2s cubic-bezier(0.4, 0, 0.2, 1);
      overflow:hidden;
      min-height:88px;
      -webkit-tap-highlight-color: transparent;
      box-shadow:
        0 16px 26px rgba(9,28,70,.22),
        0 0 0 1px rgba(255,255,255,.08) inset;
    }
    
    .tile::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        linear-gradient(135deg, rgba(255,255,255,.30) 0%, transparent 55%),
        repeating-linear-gradient(145deg, rgba(167,228,255,.12) 0 1px, transparent 1px 14px);
      opacity:0;
      transition: opacity .2s ease;
    }
    
    .tile::after{
      content:"";
      position:absolute; 
      right:-34px;
      top:-34px;
      width:148px; 
      height:148px;
      background: radial-gradient(circle at 45% 45%, rgba(167,226,255,.18), transparent 72%);
      border-radius:50%;
      opacity:.0;
      pointer-events:none;
    }
    
    .tile:active{ 
      transform: scale(0.98);
      border-color: rgba(206,238,255,.68);
      box-shadow:
        0 8px 16px rgba(9,28,70,.22),
        0 0 0 1px rgba(214,244,255,.14) inset;
    }
    
    .tile:hover::before{
      opacity:1;
    }

    .tile:hover{
      border-color: rgba(200,238,255,.72);
      transform: translateY(-1px);
    }
    
    .tile-icon{
      width:54px;
      height:54px;
      border-radius:16px;
      background:
        linear-gradient(145deg, rgba(246,253,255,.72), rgba(212,236,255,.52)),
        rgba(194,229,255,.30);
      border:1px solid var(--tile-icon-tone);
      display:grid;
      place-items:center;
      font-size:24px;
      flex-shrink:0;
      z-index:1;
      box-shadow:
        0 8px 18px rgba(10,36,84,.18),
        0 0 0 1px rgba(255,255,255,.30) inset;
    }
    .tile-icon img{
      width:28px;
      height:28px;
      display:block;
      filter: saturate(1.15) contrast(1.1) brightness(1.04);
    }
    
    .tile-content{
      flex:1;
      min-width:0;
      z-index:1;
    }
    
    .tile-title{
      font-size:16px;
      font-weight:700;
      letter-spacing:-.01em;
      margin-bottom:4px;
      color:var(--text);
    }
    
    .tile-desc{
      font-size:13px;
      color:var(--muted);
      opacity:.85;
      line-height:1.35;
    }
    
    .tile-arrow{
      width:14px;
      height:14px;
      border-radius:0;
      background:none;
      border:0;
      display:block;
      font-size:0;
      flex-shrink:0;
      z-index:1;
      transition: transform .2s ease;
      position:relative;
      box-shadow:none;
    }

    .tile-arrow::before{
      content:"";
      position:absolute;
      inset:0;
      clip-path: polygon(0 0, 100% 50%, 0 100%);
      background: var(--tile-icon-tone);
    }

    .tile-arrow::after{
      content:none;
    }
    
    .tile:active .tile-arrow{
      transform: translateX(2px) scale(0.98);
    }

    /* Bottom sheet */
    .sheet{
      position:fixed;
      inset:0;
      z-index:1000;
      display:none;
      background: rgba(12,30,64,.54);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      animation: fadeIn .3s ease;
    }
    .sheet.show{ display:block; }
    
    @keyframes fadeIn{
      from{ opacity:0; }
      to{ opacity:1; }
    }
    
    .sheet-panel{
      position:absolute;
      bottom:0;
      left:0;
      right:0;
      background: linear-gradient(180deg, rgba(236,248,255,.28), rgba(177,222,255,.16));
      border-radius: 28px 28px 0 0;
      border:1px solid rgba(173,224,255,.44);
      border-bottom:0;
      box-shadow: 
        0 -20px 80px rgba(8,22,58,.44),
        0 0 0 1px rgba(233,247,255,.18) inset;
      backdrop-filter: blur(30px);
      -webkit-backdrop-filter: blur(30px);
      max-height:85vh;
      display:flex;
      flex-direction:column;
      animation: slideUp .4s cubic-bezier(0.16, 1, 0.3, 1);
      padding-bottom: calc(var(--safe-bottom) + 20px);
    }
    
    @keyframes slideUp{
      from{ transform: translateY(100%); }
      to{ transform: translateY(0); }
    }
    
    .sheet-handle{
      width:40px;
      height:5px;
      background: rgba(255,255,255,.25);
      border-radius:999px;
      margin:12px auto 8px;
      flex-shrink:0;
    }
    
    .sheet-header{
      padding:16px 24px 20px;
      border-bottom:1px solid rgba(255,255,255,.10);
      flex-shrink:0;
    }
    
    .sheet-top{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    
    .sheet-type-badge{
      font-size:10px;
      font-weight:700;
      padding:5px 10px;
      border-radius:8px;
      background: rgba(92,59,255,.18);
      border:1px solid rgba(92,59,255,.30);
      color: rgba(234,240,255,.85);
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    
    .sheet-close{
      margin-left:auto;
      width:32px;
      height:32px;
      border-radius:10px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      display:grid;
      place-items:center;
      cursor:pointer;
      font-size:18px;
      transition: all .2s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .sheet-close img{
      width:14px;
      height:14px;
      display:block;
    }
    
    .sheet-close:active{
      transform: scale(0.95);
      background: rgba(255,255,255,.12);
    }
    
    .sheet-title{
      font-size:24px;
      font-weight:800;
      letter-spacing:-.02em;
      margin-bottom:6px;
    }
    
    .sheet-hint{
      font-size:14px;
      color:var(--muted);
      opacity:.85;
      line-height:1.4;
    }
    
    /* Segments (tabs) */
    .segments{
      display:flex;
      gap:8px;
      padding:16px 24px;
      overflow-x:auto;
      border-bottom:1px solid rgba(255,255,255,.08);
      flex-shrink:0;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
    }
    .segments::-webkit-scrollbar{ display:none; }
    
    .seg{
      padding:10px 18px;
      border-radius:12px;
      background:
        linear-gradient(145deg, rgba(238,250,255,.24), rgba(154,205,255,.10));
      border:1px solid rgba(183,228,255,.36);
      font-size:14px;
      font-weight:600;
      color:rgba(243,249,255,.88);
      cursor:pointer;
      white-space:nowrap;
      transition: all .2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    
    .seg.active{
      background: linear-gradient(135deg, rgba(104,116,255,.34), rgba(53,240,210,.28));
      border-color: rgba(212,243,255,.60);
      color:var(--text);
      box-shadow: 
        0 6px 18px rgba(84,111,255,.22),
        0 0 0 1px rgba(233,248,255,.16) inset;
    }
    
    .seg:active{
      transform: scale(0.96);
    }
    
    /* Content area */
    .sheet-content{
      padding:24px;
      overflow-y:auto;
      flex:1;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.15) transparent;
    }
    .sheet-content::-webkit-scrollbar{
      width:6px;
    }
    .sheet-content::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.15);
      border-radius:999px;
    }
    
    .form-group{
      margin-bottom:20px;
    }
    
    .field{
      margin-bottom:18px;
      position:relative;
      border-radius:16px;
      padding:12px 12px 10px;
      background:
        linear-gradient(160deg, rgba(236,248,255,.18), rgba(171,220,255,.08));
      border:1px solid rgba(177,226,255,.32);
      box-shadow:
        0 8px 18px rgba(8,28,66,.16),
        0 0 0 1px rgba(224,246,255,.10) inset;
      overflow:hidden;
    }

    .field::before{
      content:"";
      position:absolute;
      top:0;
      right:0;
      width:78px;
      height:78px;
      background:
        linear-gradient(135deg, rgba(90,118,255,.32), rgba(53,240,210,.12) 60%, transparent 70%);
      clip-path: polygon(100% 0, 0 0, 100% 100%);
      pointer-events:none;
    }

    .field::after{
      content:"";
      position:absolute;
      left:12px;
      right:12px;
      bottom:8px;
      height:1px;
      background: linear-gradient(90deg, rgba(53,240,210,.65), rgba(130,110,255,.0));
      pointer-events:none;
    }
    
    .field label{
      display:block;
      font-size:13px;
      font-weight:600;
      color:var(--text);
      margin-bottom:10px;
      letter-spacing:.01em;
      opacity:.9;
      position:relative;
      z-index:1;
    }
    
    .field select,
    .field input{
      width:100%;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid transparent;
      background:
        linear-gradient(135deg, rgba(241,251,255,.28), rgba(172,221,255,.14)) padding-box,
        linear-gradient(130deg, rgba(203,239,255,.72), rgba(104,117,255,.56)) border-box;
      color:var(--text);
      font-size:15px;
      font-family: inherit;
      transition: all .2s ease;
      -webkit-appearance: none;
      appearance: none;
      position:relative;
      z-index:1;
      box-shadow:
        0 6px 16px rgba(10,31,74,.20),
        0 0 0 1px rgba(240,251,255,.10) inset;
    }
    
    .field select{
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' fill='%23EAF0FF'%3E%3Cpath d='M1 1l5 5 5-5'/%3E%3C/svg%3E") no-repeat right 14px center,
        linear-gradient(135deg, rgba(241,251,255,.28), rgba(172,221,255,.14)) padding-box,
        linear-gradient(130deg, rgba(203,239,255,.72), rgba(104,117,255,.56)) border-box;
      padding-right:40px;
    }
    
    .field select:focus,
    .field input:focus{
      outline:none;
      border:1px solid transparent;
      background:
        linear-gradient(135deg, rgba(245,252,255,.36), rgba(191,236,255,.20)) padding-box,
        linear-gradient(130deg, rgba(53,240,210,.95), rgba(130,110,255,.85)) border-box;
      box-shadow:
        0 0 0 3px rgba(53,240,210,.18),
        0 8px 18px rgba(10,31,74,.26);
    }

    .field select:focus{
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' fill='%23EAF0FF'%3E%3Cpath d='M1 1l5 5 5-5'/%3E%3C/svg%3E") no-repeat right 14px center,
        linear-gradient(135deg, rgba(245,252,255,.36), rgba(191,236,255,.20)) padding-box,
        linear-gradient(130deg, rgba(53,240,210,.95), rgba(130,110,255,.85)) border-box;
    }
    
    .field select option{
      background: #123165;
      color:var(--text);
    }
    
    .note{
      padding:14px 16px;
      border-radius:14px;
      background: rgba(0,255,170,.08);
      border:1px solid rgba(0,255,170,.20);
      font-size:13px;
      color: rgba(234,240,255,.85);
      line-height:1.5;
    }

    .note-actions{
      display:flex;
      gap:10px;
      margin-top:12px;
    }

    .note-actions .btn{
      width:auto;
      flex:1 1 0;
      padding:12px 14px;
      font-size:14px;
      border-radius:12px;
    }
    
    /* Footer */
    .sheet-footer{
      padding:20px 24px 0;
      border-top:1px solid rgba(255,255,255,.08);
      flex-shrink:0;
    }
    
    .btn{
      width:100%;
      padding:16px;
      border-radius:16px;
      border:none;
      font-size:16px;
      font-weight:700;
      font-family: inherit;
      cursor:pointer;
      transition: all .2s cubic-bezier(0.4, 0, 0.2, 1);
      letter-spacing:.01em;
      -webkit-tap-highlight-color: transparent;
      position:relative;
      overflow:hidden;
    }
    
    .btn-primary{
      background: linear-gradient(135deg, #35f0d2 0%, #45b8ff 100%);
      color: #062041;
      box-shadow: 
        0 8px 24px rgba(69,184,255,.34),
        0 0 0 1px rgba(255,255,255,.15) inset;
    }
    
    .btn-primary::before{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(135deg, rgba(255,255,255,.20), transparent);
      opacity:0;
      transition: opacity .2s ease;
    }
    
    .btn-primary:hover::before{
      opacity:1;
    }
    
    .btn-primary:active{
      transform: scale(0.98);
      box-shadow: 
        0 4px 16px rgba(0,255,170,.25),
        0 0 0 1px rgba(255,255,255,.15) inset;
    }
    
    .btn-primary:disabled{
      opacity:.5;
      cursor:not-allowed;
      transform: none !important;
    }

    .btn-secondary{
      background: linear-gradient(135deg, rgba(231,247,255,.40), rgba(176,222,255,.26));
      color: rgba(245,251,255,.95);
      border:1px solid rgba(203,235,255,.45);
      box-shadow:
        0 8px 20px rgba(10,36,84,.22),
        0 0 0 1px rgba(236,249,255,.16) inset;
    }

    .btn-secondary:active{
      transform: scale(0.98);
    }
    
    /* Loading state */
    .loading{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    
    .spinner{
      width:16px;
      height:16px;
      border:2px solid rgba(3,6,17,.3);
      border-top-color:#030611;
      border-radius:50%;
      animation: spin .6s linear infinite;
    }
    
    @keyframes spin{
      to{ transform: rotate(360deg); }
    }
    
    /* Success toast */
    .toast{
      position:fixed;
      top:calc(20px + var(--safe-top));
      left:50%;
      transform: translateX(-50%) translateY(-100px);
      background: linear-gradient(135deg, rgba(0,255,170,.95), rgba(0,200,140,.95));
      color:#030611;
      padding:16px 24px;
      border-radius:16px;
      font-size:15px;
      font-weight:700;
      box-shadow: 
        0 12px 40px rgba(0,255,170,.35),
        0 0 0 1px rgba(255,255,255,.20) inset;
      z-index:10000;
      opacity:0;
      transition: all .4s cubic-bezier(0.16, 1, 0.3, 1);
      pointer-events:none;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      gap:10px;
      white-space: nowrap;
    }

    .toast::before{
      content:"";
      width:16px;
      height:16px;
      flex:0 0 16px;
      background: url("icons/check.svg") no-repeat center / contain;
    }
    
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(0);
    }
    
    /* Skeleton loading */
    .skeleton{
      background: linear-gradient(90deg, 
        rgba(255,255,255,.05) 0%, 
        rgba(255,255,255,.10) 50%, 
        rgba(255,255,255,.05) 100%);
      background-size: 200% 100%;
      animation: skeleton 1.5s ease-in-out infinite;
      border-radius: inherit;
    }
    
    @keyframes skeleton{
      0%{ background-position: 200% 0; }
      100%{ background-position: -200% 0; }
    }
    
    /* Utility */
    .disabled{
      opacity:.45;
      pointer-events:none;
    }

    /* ===== Concrete Glass Test Theme ===== */
    :root{
      --bg0:#08131a;
      --bg1:#0f1f2a;
      --bg2:#102b24;
      --ink:#eaf2f5;
      --glass: rgba(225,239,245,.16);
      --glass-border: rgba(220,239,246,.28);
      --concrete-light:#d4dbe0;
      --concrete-mid:#aeb9c1;
      --concrete-dark:#8e98a0;
    }

    body{
      font-family: "Trebuchet MS", "Gill Sans MT", Candara, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 720px at 18% -8%, rgba(14,47,38,.56), transparent 62%),
        radial-gradient(980px 680px at 88% 0%, rgba(13,36,61,.55), transparent 66%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
    }

    .bg-geo,
    .noise{
      display:none;
    }

    .bg-disks{
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
      --scroll-y: 0px;
      --scroll-dir: 0;
    }
    .bg-disks .disk{
      position: absolute;
      border-radius: 999px;
      background:
        radial-gradient(circle at 32% 28%, rgba(255,255,255,.38), transparent 42%),
        radial-gradient(circle at 60% 68%, rgba(0,0,0,.18), transparent 55%),
        repeating-radial-gradient(circle at 45% 45%, rgba(255,255,255,.05) 0 2px, rgba(0,0,0,.04) 2px 4px),
        linear-gradient(145deg, #e0e5e9, #98a3ac 68%, #7f8a95);
      box-shadow:
        inset 0 2px 10px rgba(255,255,255,.28),
        inset 0 -24px 40px rgba(0,0,0,.22),
        0 36px 64px rgba(0,0,0,.36);
      filter: saturate(.82);
      opacity: .9;
      will-change: transform;
      transition: transform .2s linear;
    }
    .bg-disks .d1{
      width: 500px;
      height: 500px;
      left: -170px;
      top: -120px;
      background-blend-mode: screen, normal, normal, normal;
      transform: translate3d(calc(var(--scroll-y) * 0.04), calc(var(--scroll-y) * -0.06), 0) rotate(calc(var(--scroll-dir) * 1.2deg));
    }
    .bg-disks .d2{
      width: 430px;
      height: 430px;
      right: -120px;
      top: 130px;
      filter: hue-rotate(140deg) saturate(.78);
      transform: translate3d(calc(var(--scroll-y) * -0.03), calc(var(--scroll-y) * -0.08), 0) rotate(calc(var(--scroll-dir) * -1.5deg));
    }
    .bg-disks .d3{
      width: 560px;
      height: 560px;
      left: 45%;
      top: 54%;
      transform: translate3d(calc(-50% + var(--scroll-y) * 0.02), calc(-20% + var(--scroll-y) * -0.05), 0) rotate(calc(var(--scroll-dir) * 1deg));
      filter: hue-rotate(190deg) saturate(.78);
      opacity:.82;
    }
    .bg-disks .d4{
      width: 320px;
      height: 320px;
      left: 8%;
      bottom: -140px;
      filter: hue-rotate(35deg) saturate(.74);
      opacity:.8;
      transform: translate3d(calc(var(--scroll-y) * 0.05), calc(var(--scroll-y) * -0.03), 0) rotate(calc(var(--scroll-dir) * -1.1deg));
    }

    .wrap{
      max-width: 760px;
    }

    .card{
      background: linear-gradient(160deg, rgba(231,243,248,.20), rgba(171,196,208,.11));
      border: 1px solid var(--glass-border);
      box-shadow: 0 26px 62px rgba(3,10,16,.38), 0 0 0 1px rgba(255,255,255,.08) inset;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    .menu{
      gap: 14px;
    }

    .tile{
      border: 1px solid var(--glass-border);
      background:
        linear-gradient(140deg, rgba(236,246,250,.22), rgba(158,186,200,.11));
      box-shadow:
        0 20px 38px rgba(2,8,12,.32),
        0 0 0 1px rgba(255,255,255,.10) inset;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      padding: 18px 20px;
      min-height: 108px;
      align-items: center;
    }
    .tile::before{
      background:
        linear-gradient(160deg, rgba(255,255,255,.42) 0%, rgba(255,255,255,.06) 50%, transparent 72%);
    }
    .tile:hover{
      border-color: rgba(236,246,251,.62);
    }

    .tile-icon,
    .tile-desc,
    .tile-arrow{
      display: none !important;
    }

    .tile-content{
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      min-width: 0;
    }

    .tile-title{
      position: relative;
      display: inline-block;
      font-size: clamp(28px, 6.4vw, 40px);
      font-weight: 900;
      letter-spacing: .09em;
      line-height: 1;
      text-transform: uppercase;
      color: transparent;
      background:
        linear-gradient(170deg, rgba(255,255,255,.92), rgba(210,232,245,.78) 42%, rgba(168,198,214,.74) 65%, rgba(242,249,252,.9));
      -webkit-background-clip: text;
      background-clip: text;
      text-shadow:
        0 1px 0 rgba(255,255,255,.35),
        0 10px 16px rgba(7,16,23,.42);
      white-space: normal;
      word-break: break-word;
    }

    .tile-title::before{
      content: attr(data-text);
      position: absolute;
      inset: 0;
      color: transparent;
      background:
        linear-gradient(170deg, rgba(255,255,255,.8), rgba(214,234,244,.18) 42%, rgba(255,255,255,.74));
      -webkit-background-clip: text;
      background-clip: text;
      filter: blur(1.1px);
      opacity: .72;
      pointer-events: none;
    }

    .btn-secondary{
      background: linear-gradient(160deg, rgba(233,245,250,.22), rgba(158,183,197,.14));
      border-color: var(--glass-border);
      color: rgba(239,248,252,.92);
    }

    .sheet{
      background: rgba(4,10,15,.62);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .sheet-panel{
      background: linear-gradient(165deg, rgba(229,243,249,.22), rgba(149,176,189,.14));
      border: 1px solid var(--glass-border);
      border-bottom: 0;
      box-shadow: 0 -18px 56px rgba(0,0,0,.42), 0 0 0 1px rgba(255,255,255,.1) inset;
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
    }
    .sheet-header,
    .segments,
    .sheet-footer{
      border-color: rgba(223,239,247,.18);
    }
    .seg{
      background: linear-gradient(160deg, rgba(228,243,250,.22), rgba(151,179,193,.12));
      border-color: rgba(223,239,247,.34);
      color: rgba(236,246,250,.92);
    }
    .seg.active{
      background: linear-gradient(155deg, rgba(247,252,255,.32), rgba(168,197,212,.22));
      border-color: rgba(235,248,253,.68);
      color: rgba(245,251,255,.96);
      box-shadow: 0 10px 22px rgba(0,0,0,.24), 0 0 0 1px rgba(255,255,255,.18) inset;
    }
    .field{
      background: linear-gradient(160deg, rgba(231,244,250,.20), rgba(157,185,198,.11));
      border-color: rgba(220,238,247,.26);
      box-shadow: 0 10px 22px rgba(0,0,0,.2), 0 0 0 1px rgba(255,255,255,.08) inset;
    }
    .field::before,
    .field::after{
      display: none;
    }
    .field select,
    .field input{
      background:
        linear-gradient(150deg, rgba(242,250,254,.30), rgba(174,201,214,.16)) padding-box,
        linear-gradient(140deg, rgba(230,245,251,.62), rgba(157,186,199,.52)) border-box;
      color: rgba(236,247,252,.95);
    }
    .sheet-title{
      color: rgba(242,250,253,.95);
      text-shadow: 0 8px 18px rgba(0,0,0,.28);
    }
    .sheet-type-badge{
      background: linear-gradient(145deg, rgba(236,247,252,.25), rgba(164,191,205,.2));
      border-color: rgba(221,239,247,.4);
      color: rgba(240,248,252,.94);
    }
    .note{
      background: linear-gradient(160deg, rgba(229,244,249,.18), rgba(154,182,196,.10));
      border-color: rgba(219,237,246,.24);
      color: rgba(234,245,250,.88);
    }
    .btn-primary{
      background: linear-gradient(150deg, rgba(243,251,254,.82), rgba(178,204,217,.68));
      color: #132430;
      box-shadow: 0 10px 24px rgba(0,0,0,.28), 0 0 0 1px rgba(255,255,255,.2) inset;
    }

    .dock{
      margin-top: 16px;
      border: 1px solid var(--glass-border);
      border-radius: 22px;
      padding: 10px 8px calc(8px + var(--safe-bottom));
      background: linear-gradient(155deg, rgba(228,242,248,.18), rgba(160,188,201,.10));
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: 0 18px 44px rgba(0,0,0,.3), 0 0 0 1px rgba(255,255,255,.08) inset;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }
    .dock-item{
      border: 0;
      background: transparent;
      color: rgba(235,245,250,.94);
      display: grid;
      justify-items: center;
      gap: 6px;
      padding: 8px 4px;
      border-radius: 14px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .dock-item:active{
      background: rgba(255,255,255,.08);
      transform: scale(.98);
    }
    .dock-icon{
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 22%, rgba(255,255,255,.42), transparent 40%),
        radial-gradient(circle at 64% 78%, rgba(0,0,0,.22), transparent 58%),
        linear-gradient(145deg, #d7dee3, #9aa5ae 68%, #808b95);
      border: 1px solid rgba(236,246,252,.7);
      box-shadow: inset 0 2px 6px rgba(255,255,255,.22), 0 8px 14px rgba(0,0,0,.26);
      display: grid;
      place-items: center;
    }
    .dock-icon img{
      width: 18px;
      height: 18px;
      filter: saturate(.6) contrast(1.15) brightness(.7);
    }
    .dock-label{
      font-size: 11px;
      line-height: 1.2;
      text-align: center;
      letter-spacing: .01em;
      color: rgba(226,241,248,.9);
    }

    @media (max-width: 540px){
      .tile-title{
        letter-spacing: .05em;
      }
    }

    /* ===== Final Layout (lighter techno + folder docs + clay apps) ===== */
    :root{
      --top-dock-h: 98px;
      --bottom-dock-h: 82px;
      --glass-folder-bg: linear-gradient(155deg, rgba(246,252,255,.36), rgba(202,220,248,.20));
      --glass-folder-border: rgba(213,231,255,.62);
      --ink-dark: #132746;
    }

    body{
      background:
        radial-gradient(1200px 760px at 9% -6%, rgba(93,123,241,.34), transparent 62%),
        radial-gradient(1040px 720px at 90% 4%, rgba(81,166,130,.30), transparent 66%),
        radial-gradient(980px 700px at 52% 108%, rgba(138,94,211,.28), transparent 66%),
        linear-gradient(180deg, #1a2639, #121e30);
    }
    body::before{
      content: "";
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      background:
        repeating-linear-gradient(90deg, rgba(183,210,255,.045) 0 1px, transparent 1px 26px),
        repeating-linear-gradient(0deg, rgba(170,197,242,.04) 0 1px, transparent 1px 24px);
      mix-blend-mode: screen;
      opacity: .5;
    }

    .bg-disks .disk{
      opacity: .62;
      filter: saturate(.9);
    }

    .wrap{
      max-width: 760px;
      padding-top: calc(var(--safe-top) + var(--top-dock-h) + 14px);
      padding-bottom: calc(var(--safe-bottom) + var(--bottom-dock-h) + 16px);
    }

    .card{
      position: fixed;
      top: calc(var(--safe-top) + 8px);
      left: 50%;
      transform: translateX(-50%);
      width: min(760px, calc(100vw - 16px));
      z-index: 80;
      border-radius: 16px;
      border: 1px solid rgba(223,237,255,.55);
      background: linear-gradient(158deg, rgba(241,250,255,.3), rgba(185,206,236,.16));
      box-shadow:
        0 12px 30px rgba(6,15,34,.20),
        inset 0 1px 0 rgba(255,255,255,.30);
      backdrop-filter: blur(16px) saturate(116%);
      -webkit-backdrop-filter: blur(16px) saturate(116%);
      overflow: hidden;
    }
    .top{
      min-height: calc(var(--top-dock-h) - 2px);
      padding: 12px 14px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 12px;
    }
    .top-greet{
      min-width: 0;
      text-align: left;
    }
    .top-greet .title{
      font-size: 14px;
      font-weight: 800;
      color: var(--ink-dark);
      text-shadow: none;
    }
    .top-greet .sub{
      font-size: 13px;
      color: rgba(19,39,70,.82);
      text-shadow: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .top-actions{
      min-width: 0;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
    }
    .top-icon-btn{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid rgba(28,57,106,.24);
      background: linear-gradient(150deg, rgba(241,248,255,.72), rgba(191,214,243,.42));
      color: #133271;
      font-size: 18px;
      font-weight: 700;
      line-height: 1;
      display: grid;
      place-items: center;
      cursor: pointer;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.55);
    }
    .top-icon-btn:active{
      transform: scale(.96);
      background: linear-gradient(150deg, rgba(234,244,255,.76), rgba(180,205,236,.48));
    }
    .avatar{
      grid-column: 2;
      justify-self: center;
      width: 58px;
      height: 58px;
    }
    .access{
      display: none;
    }

    .section-head{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin: 12px 0 12px 2px;
    }
    .section-title{
      margin: 0;
      flex: 1 1 auto;
      color: rgba(231,242,255,.96);
      text-shadow: none;
    }
    .section-brand-inline{
      flex: 0 0 auto;
      text-align: right;
      color: rgba(231,242,255,.96);
      font-size: inherit;
      font-weight: inherit;
      letter-spacing: .08em;
      text-transform: uppercase;
      text-shadow: none;
      white-space: nowrap;
    }

    /* Available reports as liquid transparent rounded rectangles */
    .menu{
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 14px;
    }
    .tile{
      min-height: clamp(86px, 11vh, 108px);
      padding: clamp(10px, 1.8vh, 14px) clamp(10px, 1.8vw, 14px);
      border-radius: 16px;
      border: 1px solid var(--glass-folder-border);
      background: var(--glass-folder-bg);
      box-shadow:
        0 10px 22px rgba(5,13,30,.14),
        inset 0 1px 0 rgba(255,255,255,.30);
      backdrop-filter: blur(15px) saturate(112%);
      -webkit-backdrop-filter: blur(15px) saturate(112%);
      display: grid;
      grid-template-columns: auto 1fr;
      align-items: center;
      gap: clamp(8px, 1.4vw, 14px);
      position: relative;
      overflow: hidden;
    }
    .tile::before{
      display: none;
    }
    .tile::after{
      display: none;
    }
    .tile-icon{
      display: grid !important;
      width: clamp(38px, 9vw, 56px);
      height: clamp(38px, 9vw, 56px);
      flex: 0 0 clamp(38px, 9vw, 56px);
      border-radius: 14px;
      border: 1px solid rgba(222,238,255,.74);
      background: linear-gradient(145deg, rgba(243,250,255,.56), rgba(191,215,243,.26));
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.50);
      place-items: center;
    }
    .tile-icon img{
      width: clamp(22px, 5vw, 32px);
      height: clamp(22px, 5vw, 32px);
      filter: saturate(.84) contrast(1.04) brightness(.66);
    }
    .tile-desc,
    .tile-arrow{
      display: none !important;
    }
    .tile-content{
      width: 100%;
      min-width: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .tile-title{
      font-size: clamp(15px, 2.9vw, 21px);
      font-weight: 700;
      line-height: 1.15;
      letter-spacing: .01em;
      text-transform: none;
      color: #22395d;
      text-shadow: none;
      white-space: normal;
      overflow-wrap: anywhere;
    }
    .tile-title::before{
      display: none;
    }

    /* Bottom 3D clay apps */
    .dock{
      position: fixed;
      left: 50%;
      bottom: calc(var(--safe-bottom) + 8px);
      transform: translateX(-50%);
      width: min(760px, calc(100vw - 16px));
      z-index: 90;
      margin-top: 0;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      border: 0;
      border-radius: 0;
      padding: 0 2px;
      background: transparent;
      box-shadow: none;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }
    .dock::before{
      display: none;
    }
    .dock-item{
      border: 0;
      border-radius: 0;
      background: transparent;
      box-shadow: none;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      padding: 4px 2px;
      display: grid;
      justify-items: center;
      align-content: center;
      gap: 6px;
      cursor: pointer;
      color: #1f2a44;
    }
    .dock-item:active{
      transform: scale(.96);
      background: transparent;
    }
    .dock-icon{
      width: clamp(34px, 9.2vw, 48px);
      height: clamp(34px, 9.2vw, 48px);
      flex: 0 0 clamp(34px, 9.2vw, 48px);
      border-radius: 0;
      border: 0;
      background: transparent;
      box-shadow: none;
      display: grid;
      place-items: center;
    }
    .dock-icon img{
      width: clamp(26px, 7vw, 36px);
      height: clamp(26px, 7vw, 36px);
      object-fit: contain;
      display: block;
      filter: saturate(.9) brightness(.92);
    }
    .dock-label{
      font-size: clamp(10px, 2.2vw, 13px);
      line-height: 1.2;
      text-align: center;
      color: rgba(232,243,255,.96);
      font-weight: 700;
    }

    .history-list{
      display: grid;
      gap: 10px;
    }
    .history-item{
      width: 100%;
      border: 1px solid rgba(213,231,255,.56);
      border-radius: 14px;
      background: linear-gradient(155deg, rgba(246,252,255,.36), rgba(202,220,248,.20));
      color: #132746;
      padding: 12px;
      text-align: left;
      cursor: pointer;
      box-shadow:
        0 8px 18px rgba(7,16,35,.12),
        inset 0 1px 0 rgba(255,255,255,.34);
      backdrop-filter: blur(14px) saturate(112%);
      -webkit-backdrop-filter: blur(14px) saturate(112%);
    }
    .history-item::before{
      display: none;
    }
    .history-item strong{
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .history-item small{
      display: block;
      opacity: .78;
      line-height: 1.35;
    }
    .history-empty{
      color: rgba(236,247,255,.9);
      font-size: 14px;
      line-height: 1.5;
    }
    .etl-list{
      display: grid;
      gap: 10px;
    }
    .etl-item{
      border: 1px solid rgba(213,231,255,.56);
      border-radius: 12px;
      background: linear-gradient(155deg, rgba(246,252,255,.36), rgba(202,220,248,.20));
      padding: 10px 12px;
      color: #132746;
      backdrop-filter: blur(12px) saturate(112%);
      -webkit-backdrop-filter: blur(12px) saturate(112%);
    }
    .etl-item strong{
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .etl-item small{
      display: block;
      opacity: .82;
      line-height: 1.35;
    }

    @media (max-width: 640px){
      :root{
        --top-dock-h: 92px;
        --bottom-dock-h: 74px;
      }
      .menu{
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .tile{
        min-height: clamp(80px, 10.5vh, 96px);
        padding: 10px;
      }
      .tile-icon{
        width: clamp(36px, 10vw, 46px);
        height: clamp(36px, 10vw, 46px);
        flex-basis: clamp(36px, 10vw, 46px);
      }
      .tile-icon img{
        width: clamp(20px, 6vw, 24px);
        height: clamp(20px, 6vw, 24px);
      }
      .top-icon-btn{
        width: 32px;
        height: 32px;
        font-size: 17px;
      }
    }
  </style>
</head>
<body>
  <div class="bg-geo"></div>
  <div class="noise"></div>
  <div class="bg-disks" aria-hidden="true">
    <span class="disk d1"></span>
    <span class="disk d2"></span>
    <span class="disk d3"></span>
    <span class="disk d4"></span>
  </div>
  
  <div class="intro" id="intro">
    <div class="logo">GROO</div>
    <div class="bar"></div>
    <div class="fade"></div>
  </div>

  <div class="wrap" id="app">
    <div class="card">
      <div class="top">
        <div class="top-greet">
          <div class="title" id="welcomeTitle">Welcome</div>
          <div class="sub" id="welcomeSub">User</div>
        </div>
        <div class="avatar" id="avatar">??</div>
        <div class="top-actions">
          <button class="top-icon-btn" id="btnSettings" aria-label="Settings">‚öô</button>
          <button class="top-icon-btn" id="btnBell" aria-label="ETL updates">üîî</button>
        </div>
      </div>
      
      <div class="access">
        <div class="access-icon" id="accessIcon"><img src="icons/lock.svg" alt="" width="20" height="20"></div>
        <div class="access-text">
          <div class="access-msg" id="accessMsg">Checking access...</div>
        </div>
        <div class="badge" id="accessBadge">...</div>
      </div>
    </div>

    <div class="section-head">
      <div class="section-title" id="sectionTitle">Available Reports</div>
      <div class="section-brand-inline" id="sectionBrand">GROO&nbsp;&nbsp;GmbH</div>
    </div>
    
    <div class="menu" id="menu">
      <div class="tile" data-report="container">
        <div class="tile-icon"><img src="icons/container.svg" alt="" width="22" height="22"></div>
        <div class="tile-content">
          <div class="tile-title">Bericht</div>
        </div>
      </div>

      <div class="tile" data-report="data-plan">
        <div class="tile-icon"><img src="icons/check.svg" alt="" width="22" height="22"></div>
        <div class="tile-content">
          <div class="tile-title">Data/Plan</div>
        </div>
      </div>

      <div class="tile" data-report="lkw">
        <div class="tile-icon"><img src="icons/truck.svg" alt="" width="22" height="22"></div>
        <div class="tile-content">
          <div class="tile-title">LKW</div>
        </div>
      </div>

      <div class="tile" data-report="fahrer">
        <div class="tile-icon"><img src="icons/driver.svg" alt="" width="22" height="22"></div>
        <div class="tile-content">
          <div class="tile-title">Fahrer</div>
        </div>
      </div>

      <div class="tile" data-report="yf">
        <div class="tile-icon"><img src="icons/chart.svg" alt="" width="22" height="22"></div>
        <div class="tile-content">
          <div class="tile-title">Yellow Fox</div>
        </div>
      </div>

      <div class="tile" data-report="einnahmen">
        <div class="tile-icon"><img src="icons/money.svg" alt="" width="22" height="22"></div>
        <div class="tile-content">
          <div class="tile-title">Einnahmen</div>
        </div>
      </div>

      <div class="tile" data-report="bonus">
        <div class="tile-icon"><img src="icons/target.svg" alt="" width="22" height="22"></div>
        <div class="tile-content">
          <div class="tile-title">Bonus</div>
        </div>
      </div>
    </div>

    <div class="dock" id="dock">
      <button class="dock-item" data-dock="history">
        <span class="dock-icon"><img src="icons/folder.svg" alt="" width="18" height="18"></span>
        <span class="dock-label" id="dock-history-label">Historie</span>
      </button>
      <button class="dock-item" data-dock="lkw-list">
        <span class="dock-icon"><img src="icons/truck.svg" alt="" width="18" height="18"></span>
        <span class="dock-label" id="dock-lkw-label">LKW</span>
      </button>
      <button class="dock-item" data-dock="drivers-list">
        <span class="dock-icon"><img src="icons/driver.svg" alt="" width="18" height="18"></span>
        <span class="dock-label" id="dock-drivers-label">Fahrer</span>
      </button>
      <button class="dock-item" data-dock="fuel-cards">
        <span class="dock-icon"><img src="icons/fuel.svg" alt="" width="18" height="18"></span>
        <span class="dock-label" id="dock-fuel-label">Tankkarte</span>
      </button>
    </div>
  </div>

  <div class="sheet" id="sheet">
    <div class="sheet-panel">
      <div class="sheet-handle"></div>
      
      <div class="sheet-header">
        <div class="sheet-top">
          <div class="sheet-type-badge" id="sheetType">Params</div>
          <div class="sheet-close" id="btnClose"><img src="icons/close.svg" alt="Close" width="14" height="14"></div>
        </div>
        <div class="sheet-title" id="sheetTitle">Report</div>
        <div class="sheet-hint" id="sheetHint">Configure parameters</div>
      </div>
      
      <div class="segments" id="segments"></div>
      
      <div class="sheet-content">
        <div class="form-group" id="formArea"></div>
        <div id="noteArea"></div>
      </div>
      
      <div class="sheet-footer">
        <button class="btn btn-primary" id="btnPrimary">Generate Report</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">PDF is ready</div>

  <script>
    // === CONFIG ===
    const ADMIN = "@GROO_LKW_Report_bot";
    
    const DEMO_VEHICLES = ["MAN-TGX-001","SCANIA-R500-002","VOLVO-FH-003","DAF-XF-004","IVECO-S-WAY-005"];
    const DEMO_DRIVERS = ["Schmidt M.","M√ºller P.","Fischer T.","Weber K.","Meyer L."];

    // === LOCALIZATION ===
    const LANG = {
      en: {
        welcome: "Welcome",
        checking: "Checking access rights...",
        accessOk: "Access granted ‚Ä¢ All reports available",
        accessNo: (admin) => `Access denied ‚Ä¢ Contact ${admin}`,
        accessApiPending: "API is not connected yet ‚Ä¢ UI preview mode",
        ok: "OK",
        no: "NO",
        pending: "INFO",
        sectionTitle: "Available Reports",
        navHistory: "Historie",
        navLkwList: "LKW",
        navDriversList: "Fahrer",
        navFuelCards: "Tankkarte",
        yourTelegramId: "Your Telegram ID",
        etlTitle: "ETL Updates",
        etlHint: "Last successful imports",
        etlDataFile: "LKW_Fahrer_Data.xlsm",
        etlPlanFile: "LKW_Fahrer_Plan.xlsb",
        noEtlUpdate: "No successful update yet",
        close: "Close",
        historyTitle: "Generated Files",
        historyHint: "Tap a file to open it",
        historyEmpty: "No generated files yet.",
        loadingHistory: "Loading history...",
        loadingPdf: "Preparing PDF...",
        lkwDockTitle: "LKW List PDF",
        driversDockTitle: "Drivers List PDF",
        fuelDockTitle: "Fuel Cards PDF",
        
        // Descriptions
        descContainer: "Run current Bericht PDF report",
        descLkw: "Truck reports and analytics",
        descFahrer: "Driver data and vacation",
        descYf: "Mileage and fuel reports",
        descEinnahmen: "Total revenue overview",
        descBonus: "Bonus calculations",
        
        // Sheet headers
        hintContainer: "Select year and week for Bericht report",
        hintLkw: "Choose truck and report type",
        hintFahrer: "Driver information and vacation data",
        hintYf: "Vehicle mileage and fuel consumption",
        hintEinnahmen: "Total revenue report for all operations",
        hintBonus: "Calculate driver bonuses",
        hintDataPlan: "Sync plan workbook from source data",
        
        // Common
        choose: "Choose...",
        vehicle: "Vehicle",
        period: "Period",
        year: "Year",
        week: "Week",
        month: "Month",
        allTime: "All time",
        driver: "Driver",
        generate: "Generate",
        send: "Send",
        openFullscreen: "Open full screen",
        
        // Tabs
        tabMileage: "Mileage",
        tabRepair: "Repairs",
        tabDriverData: "Driver Data",
        tabUrlaub: "Vacation",
        
        // Toast
        toastSuccess: "Request completed",
        toastPdfReady: "PDF is ready. Tap Open PDF",
        toastComingSoon: "Feature coming soon",
        toastPlanUpdateSent: "Plan update request sent",
        toastPlanUpdateNotSupported: "Mini App sendData is not available",
        backendNotReady: "Backend is not connected yet",
        fullscreenRequested: "Switched to full screen",
        pdfReadyNote: "PDF generated successfully.",
        openPdf: "Open PDF",
        savePdf: "Save PDF",
      },
      ru: {
        welcome: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å",
        checking: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞...",
        accessOk: "–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω ‚Ä¢ –í—Å–µ –æ—Ç—á–µ—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã",
        accessNo: (admin) => `–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω ‚Ä¢ –°–≤—è–∂–∏—Ç–µ—Å—å —Å ${admin}`,
        accessApiPending: "API –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω ‚Ä¢ —Ä–µ–∂–∏–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ UI",
        ok: "–î–ê",
        no: "–ù–ï–¢",
        pending: "–ò–ù–§–û",
        sectionTitle: "–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ—Ç—á–µ—Ç—ã",
        navHistory: "Historie",
        navLkwList: "LKW",
        navDriversList: "Fahrer",
        navFuelCards: "Tankkarte",
        yourTelegramId: "–¢–≤–æ–π Telegram ID",
        etlTitle: "ETL –û–±–Ω–æ–≤–ª–µ–Ω–∏—è",
        etlHint: "–ü–æ—Å–ª–µ–¥–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã",
        etlDataFile: "LKW_Fahrer_Data.xlsm",
        etlPlanFile: "LKW_Fahrer_Plan.xlsb",
        noEtlUpdate: "–£—Å–ø–µ—à–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç",
        close: "–ó–∞–∫—Ä—ã—Ç—å",
        historyTitle: "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã",
        historyHint: "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ñ–∞–π–ª, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å",
        historyEmpty: "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.",
        loadingHistory: "–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...",
        loadingPdf: "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ PDF...",
        lkwDockTitle: "PDF —Å–ø–∏—Å–∫–∞ LKW",
        driversDockTitle: "PDF —Å–ø–∏—Å–∫–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–π",
        fuelDockTitle: "PDF —Ç–æ–ø–ª–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç",
        
        // Descriptions
        descContainer: "–ó–∞–ø—É—Å–∫ —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç—á–µ—Ç–∞ Bericht PDF",
        descLkw: "–û—Ç—á–µ—Ç—ã –ø–æ –≥—Ä—É–∑–æ–≤–∏–∫–∞–º",
        descFahrer: "–î–∞–Ω–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–µ–π –∏ –æ—Ç–ø—É—Å–∫–∞",
        descYf: "–ü—Ä–æ–±–µ–≥ –∏ —Ä–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞",
        descEinnahmen: "–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞",
        descBonus: "–†–∞—Å—á–µ—Ç –±–æ–Ω—É—Å–æ–≤",
        
        // Sheet headers
        hintContainer: "–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–¥ –∏ –Ω–µ–¥–µ–ª—é –¥–ª—è –æ—Ç—á–µ—Ç–∞ Bericht",
        hintLkw: "–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–∑–æ–≤–∏–∫ –∏ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞",
        hintFahrer: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–æ–¥–∏—Ç–µ–ª—è—Ö –∏ –æ—Ç–ø—É—Å–∫–∞—Ö",
        hintYf: "–ü—Ä–æ–±–µ–≥ –∏ —Ä–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞",
        hintEinnahmen: "–û—Ç—á–µ—Ç –ø–æ –æ–±—â–µ–π –≤—ã—Ä—É—á–∫–µ",
        hintBonus: "–†–∞—Å—á–µ—Ç –±–æ–Ω—É—Å–æ–≤ –≤–æ–¥–∏—Ç–µ–ª–µ–π",
        hintDataPlan: "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–ª–∞–Ω-—Ñ–∞–π–ª–∞ –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö",
        
        // Common
        choose: "–í—ã–±—Ä–∞—Ç—å...",
        vehicle: "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç",
        period: "–ü–µ—Ä–∏–æ–¥",
        year: "–ì–æ–¥",
        week: "–ù–µ–¥–µ–ª—è",
        month: "–ú–µ—Å—è—Ü",
        allTime: "–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è",
        driver: "–í–æ–¥–∏—Ç–µ–ª—å",
        generate: "–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å",
        send: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å",
        openFullscreen: "–û—Ç–∫—Ä—ã—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω",
        
        // Tabs
        tabMileage: "–ü—Ä–æ–±–µ–≥",
        tabRepair: "–†–µ–º–æ–Ω—Ç—ã",
        tabDriverData: "–î–∞–Ω–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª—è",
        tabUrlaub: "–û—Ç–ø—É—Å–∫",
        
        // Toast
        toastSuccess: "–ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω",
        toastPdfReady: "PDF –≥–æ—Ç–æ–≤. –ù–∞–∂–º–∏—Ç–µ ¬´–û—Ç–∫—Ä—ã—Ç—å PDF¬ª",
        toastComingSoon: "–§—É–Ω–∫—Ü–∏—è —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞",
        toastPlanUpdateSent: "–ó–∞–ø—Ä–æ—Å –Ω–∞ –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—é –ø–ª–∞–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω",
        toastPlanUpdateNotSupported: "–í —ç—Ç–æ–º –∫–ª–∏–µ–Ω—Ç–µ sendData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω",
        backendNotReady: "Backend –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω",
        fullscreenRequested: "–û—Ç–∫—Ä—ã–≤–∞—é –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω",
        pdfReadyNote: "PDF —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω.",
        openPdf: "–û—Ç–∫—Ä—ã—Ç—å PDF",
        savePdf: "–°–∫–∞—á–∞—Ç—å PDF",
      },
    };

    let currentLang = "en";
    let latestPdfUrl = "";
    let latestPdfFilename = "";
    let latestPdfOpenUrl = "";
    let latestPdfSaveUrl = "";

    // === UTILS ===
    const $ = (id) => document.getElementById(id);
    const initials = (name) => name.split(" ").map(w => w[0]).join("").toUpperCase().slice(0,2);
    
    function detectLanguage() {
      try {
        const tgLang = Telegram?.WebApp?.initDataUnsafe?.user?.language_code || "";
        return tgLang.startsWith("ru") ? "ru" : "en";
      } catch {
        return "en";
      }
    }
    
    function L(key, ...args) {
      const value = LANG[currentLang][key];
      return typeof value === "function" ? value(...args) : value;
    }
    
    function haptic(type = "impact") {
      try {
        if (type === "impact") Telegram?.WebApp?.HapticFeedback?.impactOccurred("medium");
        else if (type === "success") Telegram?.WebApp?.HapticFeedback?.notificationOccurred("success");
        else if (type === "error") Telegram?.WebApp?.HapticFeedback?.notificationOccurred("error");
      } catch {}
    }

    function showToast(message, duration = 2500) {
      const toast = $("toast");
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), duration);
    }

    function clearPdfUrl() {
      if (latestPdfUrl) URL.revokeObjectURL(latestPdfUrl);
      latestPdfUrl = "";
      latestPdfFilename = "";
      latestPdfOpenUrl = "";
      latestPdfSaveUrl = "";
    }

    function openPdfInNewTab(url, filename) {
      const a = document.createElement("a");
      a.href = url;
      a.target = "_blank";
      a.rel = "noopener";
      a.download = filename || "report.pdf";
      a.style.display = "none";
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function triggerPdfDownload(url, filename) {
      const a = document.createElement("a");
      a.href = url;
      a.download = filename || "report.pdf";
      a.target = "_blank";
      a.rel = "noopener";
      a.style.display = "none";
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function buildGenerateDirectUrl(reportType, payload, initData, disposition = "attachment") {
      const u = new URL("/api/generate", window.location.origin);
      u.searchParams.set("initData", initData || "");
      u.searchParams.set("report_type", reportType || "");
      if (payload && payload.year !== undefined) u.searchParams.set("year", String(payload.year));
      if (payload && payload.week !== undefined) u.searchParams.set("week", String(payload.week));
      if (disposition) u.searchParams.set("disposition", disposition);
      return u.toString();
    }

    function buildDockPdfDirectUrl(kind, initData, disposition = "attachment") {
      const u = new URL("/api/dock-pdf", window.location.origin);
      u.searchParams.set("initData", initData || "");
      u.searchParams.set("kind", kind || "");
      if (disposition) u.searchParams.set("disposition", disposition);
      return u.toString();
    }

    function buildHistoryEntryOpenUrl(item, initData, disposition = "inline") {
      const type = String(item?.report_type || "");
      if (type === "bericht" && item?.iso_year && item?.iso_week) {
        return buildGenerateDirectUrl(
          "bericht",
          { year: Number(item.iso_year), week: Number(item.iso_week) },
          initData || "",
          disposition,
        );
      }

      const dockKind = item?.dock_kind || {
        lkw_list: "lkw-list",
        drivers_list: "drivers-list",
        fuel_cards: "fuel-cards",
      }[type];
      if (dockKind) {
        return buildDockPdfDirectUrl(dockKind, initData || "", disposition);
      }
      return "";
    }

    function openDirectUrl(url, fallbackBlobUrl, filename) {
      if (url) {
        try {
          if (Telegram?.WebApp?.openLink) {
            Telegram.WebApp.openLink(url);
            return;
          }
        } catch {}
        openPdfInNewTab(url, filename);
        return;
      }
      if (fallbackBlobUrl) openPdfInNewTab(fallbackBlobUrl, filename);
    }

    function saveDirectUrl(url, fallbackBlobUrl, filename) {
      if (url) {
        triggerPdfDownload(url, filename);
        return;
      }
      if (fallbackBlobUrl) triggerPdfDownload(fallbackBlobUrl, filename);
    }

    function renderPdfActions() {
      setNote(`
        <div>${L("pdfReadyNote")}</div>
        <div class="note-actions">
          <button class="btn btn-secondary" id="btnOpenPdf">${L("openPdf")}</button>
          <button class="btn btn-secondary" id="btnSavePdf">${L("savePdf")}</button>
        </div>
      `);
      const openBtn = $("btnOpenPdf");
      const saveBtn = $("btnSavePdf");
      if (openBtn) {
        openBtn.onclick = () => {
          haptic("impact");
          openDirectUrl(latestPdfOpenUrl, latestPdfUrl, latestPdfFilename);
        };
      }
      if (saveBtn) {
        saveBtn.onclick = () => {
          haptic("impact");
          saveDirectUrl(latestPdfSaveUrl, latestPdfUrl, latestPdfFilename);
        };
      }
    }

    async function showIntroThenApp() {
      return new Promise(resolve => {
        setTimeout(() => {
          $("intro").classList.add("hidden");
          resolve();
        }, 1200);
      });
    }

    function getTgContext() {
      try {
        return {
          user: Telegram.WebApp.initDataUnsafe.user || {},
          initData: Telegram.WebApp.initData || "",
        };
      } catch {
        return { user: {}, initData: "" };
      }
    }

    function getISOWeek(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function getISOYear(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      return d.getUTCFullYear();
    }

    function buildWeekOptions() {
      let out = "";
      for (let i = 1; i <= 53; i += 1) {
        out += `<option value="${i}">${L("week")} ${String(i).padStart(2, "0")}</option>`;
      }
      return out;
    }

    async function checkAccessServer() {
      try {
        const ctx = getTgContext();
        const metaUrl = new URL("/api/meta", window.location.origin);
        if (ctx.initData) metaUrl.searchParams.set("initData", ctx.initData);

        const resp = await fetch(metaUrl.toString(), {
          cache: "no-store",
          headers: { "Accept": "application/json" },
        });
        if (!resp.ok) return { state: "pending" };

        const ct = (resp.headers.get("content-type") || "").toLowerCase();
        if (!ct.includes("application/json")) return { state: "pending" };

        const data = await resp.json().catch(() => null);
        if (!data || typeof data !== "object") return { state: "pending" };

        const accessAllowed = data?.access?.allowed;
        if (accessAllowed === true) return { state: "ok" };
        if (accessAllowed === false) return { state: "denied" };

        if (typeof data.ok === "boolean") {
          return { state: data.ok ? "ok" : "denied" };
        }
        return { state: "pending" };
      } catch {
        return { state: "pending" };
      }
    }

    async function fetchMetaServer() {
      const ctx = getTgContext();
      const metaUrl = new URL("/api/meta", window.location.origin);
      if (ctx.initData) metaUrl.searchParams.set("initData", ctx.initData);
      const resp = await fetch(metaUrl.toString(), {
        cache: "no-store",
        headers: { "Accept": "application/json" },
      });
      const data = await resp.json().catch(() => null);
      if (!resp.ok || !data || typeof data !== "object") {
        throw new Error(data?.error || "Failed to load meta");
      }
      return data;
    }

    function formatDateTimeLocal(isoString) {
      const ts = Date.parse(String(isoString || ""));
      if (!Number.isFinite(ts)) return L("noEtlUpdate");
      return new Date(ts).toLocaleString();
    }

    function showTelegramId() {
      const ctx = getTgContext();
      const userId = ctx?.user?.id ? String(ctx.user.id) : "-";
      haptic("impact");
      showToast(`${L("yourTelegramId")}: ${userId}`, 2600);
    }

    async function showEtlUpdates() {
      haptic("impact");
      setSheetHeader(L("etlTitle"), L("etlHint"), "ETL");
      setSegments([], "", () => {});
      setForm(`<div class="history-empty">${L("loadingHistory")}</div>`);
      setNote("");
      $("btnPrimary").textContent = L("close");
      $("btnPrimary").onclick = closeSheet;
      openSheet();

      try {
        const meta = await fetchMetaServer();
        const sources = meta?.etl?.sources || {};
        const xlsm = sources?.xlsm_lkw_fahrer_data || {};
        const xlsb = sources?.xlsb_fahrer_plan || {};

        const html = `
          <div class="etl-list">
            <div class="etl-item">
              <strong>${L("etlDataFile")}</strong>
              <small>${formatDateTimeLocal(xlsm.last_import_at)}</small>
            </div>
            <div class="etl-item">
              <strong>${L("etlPlanFile")}</strong>
              <small>${formatDateTimeLocal(xlsb.last_import_at)}</small>
            </div>
          </div>
        `;
        setForm(html);
      } catch (err) {
        setForm(`<div class="history-empty">${err?.message || "Failed to load ETL updates"}</div>`);
      }
    }

    async function sendReportGenerate(reportType, payload) {
      haptic("impact");
      
      const btn = $("btnPrimary");
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"><span class="spinner"></span>Sending...</span>';

      try {
        clearPdfUrl();
        const ctx = getTgContext();
        const resp = await fetch("/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            initData: ctx.initData || "",
            report_type: reportType,
            ...payload,
          }),
        });
        const ct = (resp.headers.get("content-type") || "").toLowerCase();
        if (resp.ok && ct.includes("application/pdf")) {
          const blob = await resp.blob();
          const disposition = String(resp.headers.get("content-disposition") || "");
          const filenameMatch = disposition.match(/filename=\"?([^\";]+)\"?/i);
          const filename = filenameMatch?.[1] || `${reportType}.pdf`;

          latestPdfUrl = URL.createObjectURL(blob);
          latestPdfFilename = filename;
          latestPdfOpenUrl = buildGenerateDirectUrl(reportType, payload, ctx.initData || "", "inline");
          latestPdfSaveUrl = buildGenerateDirectUrl(reportType, payload, ctx.initData || "", "attachment");
          renderPdfActions();

          haptic("success");
          showToast(L("toastPdfReady"));
          return true;
        }

        const data = await resp.json().catch(() => ({}));
        if (resp.ok && data.ok) {
          haptic("success");
          showToast(L("toastSuccess"));
          closeSheet();
          return true;
        }

        const backendNotReady = ct.includes("text/html");
        haptic("error");
        showToast(data.error || (backendNotReady ? L("backendNotReady") : "Error"));
        return false;
      } catch (err) {
        haptic("error");
        showToast(err?.message || "Network error");
        return false;
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    function sendToBot(payload) {
      const data = payload || {};
      try {
        if (Telegram?.WebApp?.sendData) {
          Telegram.WebApp.sendData(JSON.stringify(data));
          return true;
        }
      } catch {}
      return false;
    }

    async function requestPlanUpdate() {
      const ctx = getTgContext();
      if (!ctx.initData) throw new Error("initData is missing");
      const resp = await fetch("/api/plan-update", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept": "application/json" },
        body: JSON.stringify({
          initData: ctx.initData || "",
          source: "miniapp",
        }),
      });
      const data = await resp.json().catch(() => null);
      if (!resp.ok || !data || data.ok !== true) {
        throw new Error(data?.error || "Failed to queue plan update");
      }
      return data;
    }

    async function openDockPdf(kind, titleKey) {
      haptic("impact");
      showToast(L("loadingPdf"), 1200);

      try {
        clearPdfUrl();
        const ctx = getTgContext();
        const openUrl = buildDockPdfDirectUrl(kind, ctx.initData || "", "inline");
        const saveUrl = buildDockPdfDirectUrl(kind, ctx.initData || "", "attachment");

        const resp = await fetch(saveUrl, {
          cache: "no-store",
          headers: { "Accept": "application/pdf" },
        });
        const ct = (resp.headers.get("content-type") || "").toLowerCase();
        if (!(resp.ok && ct.includes("application/pdf"))) {
          const data = await resp.json().catch(() => ({}));
          throw new Error(data.error || "PDF is not available");
        }

        const blob = await resp.blob();
        const disposition = String(resp.headers.get("content-disposition") || "");
        const match = disposition.match(/filename=\"?([^\";]+)\"?/i);

        latestPdfUrl = URL.createObjectURL(blob);
        latestPdfFilename = match?.[1] || `${kind}.pdf`;
        latestPdfOpenUrl = openUrl;
        latestPdfSaveUrl = saveUrl;

        setSheetHeader(L(titleKey), L("toastPdfReady"), "PDF");
        setSegments([], "", () => {});
        setForm("");
        renderPdfActions();
        openSheet();
        showToast(L("toastPdfReady"));
      } catch (err) {
        haptic("error");
        showToast(err?.message || "Network error");
      }
    }

    async function openHistory() {
      haptic("impact");
      setSheetHeader(L("historyTitle"), L("historyHint"), "History");
      setSegments([], "", () => {});
      setForm(`<div class="history-empty">${L("loadingHistory")}</div>`);
      setNote("");
      $("btnPrimary").textContent = L("openPdf");
      $("btnPrimary").onclick = () => closeSheet();
      openSheet();

      try {
        const ctx = getTgContext();
        const url = new URL("/api/history", window.location.origin);
        url.searchParams.set("initData", ctx.initData || "");
        url.searchParams.set("limit", "40");
        const resp = await fetch(url.toString(), {
          cache: "no-store",
          headers: { "Accept": "application/json" },
        });
        const data = await resp.json().catch(() => null);
        if (!resp.ok || !data?.ok) {
          throw new Error(data?.error || "Failed to load history");
        }

        const items = Array.isArray(data.items) ? data.items : [];
        if (!items.length) {
          setForm(`<div class="history-empty">${L("historyEmpty")}</div>`);
          return;
        }

        const html = `
          <div class="history-list">
            ${items.map((item, idx) => `
              <button class="history-item" data-history-idx="${idx}">
                <strong>${item.filename || "report.pdf"}</strong>
                <small>${item.report_type || ""}</small>
                <small>${item.completed_at || item.requested_at || ""}</small>
              </button>
            `).join("")}
          </div>
        `;
        setForm(html);

        document.querySelectorAll(".history-item").forEach((btn) => {
          btn.onclick = () => {
            const idx = Number(btn.getAttribute("data-history-idx"));
            const item = items[idx];
            const openUrl = buildHistoryEntryOpenUrl(item, ctx.initData || "", "inline");
            const saveUrl = buildHistoryEntryOpenUrl(item, ctx.initData || "", "attachment");
            if (!openUrl) {
              showToast("Open URL not available");
              return;
            }
            latestPdfOpenUrl = openUrl;
            latestPdfSaveUrl = saveUrl;
            latestPdfUrl = "";
            latestPdfFilename = item?.filename || "report.pdf";
            openDirectUrl(openUrl, "", latestPdfFilename);
          };
        });
      } catch (err) {
        setForm(`<div class="history-empty">${err?.message || "Failed to load history"}</div>`);
      }
    }

    async function tryAttachAvatarFromSrc(avatar, name, src) {
      if (!src) return false;
      return new Promise((resolve) => {
        const img = document.createElement("img");
        img.alt = name;
        img.referrerPolicy = "no-referrer";
        img.onload = () => {
          avatar.textContent = "";
          avatar.innerHTML = "";
          avatar.appendChild(img);
          resolve(true);
        };
        img.onerror = () => resolve(false);
        img.src = src;
      });
    }

    async function setAvatarFromTelegram(user, name, initData) {
      const avatar = $("avatar");
      const fallbackText = () => {
        avatar.textContent = initials(name);
      };

      const candidates = [];
      if (user.photo_url) candidates.push(user.photo_url);
      if (user.username) {
        const uname = String(user.username).replace(/^@+/, "");
        candidates.push(`https://t.me/i/userpic/320/${encodeURIComponent(uname)}.jpg`);
        candidates.push(`https://t.me/i/userpic/160/${encodeURIComponent(uname.toLowerCase())}.jpg`);
      }

      if (!candidates.length) {
        // Fallback to Worker proxy that resolves avatar via Bot API without exposing token.
        if (!initData) {
          fallbackText();
          return;
        }
      }

      for (const src of candidates) {
        // eslint-disable-next-line no-await-in-loop
        const ok = await tryAttachAvatarFromSrc(avatar, name, src);
        if (ok) return;
      }

      if (initData) {
        const proxyAvatar = `/api/avatar?initData=${encodeURIComponent(initData)}`;
        const ok = await tryAttachAvatarFromSrc(avatar, name, proxyAvatar);
        if (ok) return;
      }

      fallbackText();
    }

    function initBackgroundMotion() {
      const bg = document.querySelector(".bg-disks");
      if (!bg) return;

      let lastY = window.scrollY || 0;
      let rafId = 0;
      const render = () => {
        rafId = 0;
        const y = window.scrollY || 0;
        const dir = y === lastY ? 0 : (y > lastY ? 1 : -1);
        lastY = y;
        bg.style.setProperty("--scroll-y", `${Math.round(y)}px`);
        bg.style.setProperty("--scroll-dir", String(dir));
      };

      const onScroll = () => {
        if (!rafId) rafId = requestAnimationFrame(render);
      };

      window.addEventListener("scroll", onScroll, { passive: true });
      render();
    }

    // === SHEET MANAGEMENT ===
    function openSheet() {
      haptic("impact");
      $("sheet").classList.add("show");
    }

    function closeSheet() {
      haptic("impact");
      $("sheet").classList.remove("show");
      clearPdfUrl();
    }

    function setSheetHeader(title, hint, type) {
      $("sheetTitle").textContent = title;
      $("sheetHint").textContent = hint;
      $("sheetType").textContent = type;
    }

    function setSegments(tabs, active, onChange) {
      const seg = $("segments");
      seg.style.display = tabs.length ? "flex" : "none";
      seg.innerHTML = tabs.map(t => 
        `<div class="seg ${t.key === active ? "active" : ""}" data-key="${t.key}">${t.label}</div>`
      ).join("");
      
      seg.querySelectorAll(".seg").forEach(s => {
        s.onclick = () => {
          haptic("impact");
          onChange(s.getAttribute("data-key"));
        };
      });
    }

    function setForm(html) {
      $("formArea").innerHTML = html;
    }

    function setNote(text) {
      $("noteArea").innerHTML = text ? `<div class="note">${text}</div>` : "";
    }

    function optionsFrom(arr, placeholder) {
      return `<option value="">${placeholder}</option>` + 
        arr.map(v => `<option value="${v}">${v}</option>`).join("");
    }

    function buildYearOptions(from, to) {
      const now = new Date().getFullYear();
      const maxYear = Number.isFinite(Number(to)) ? Number(to) : now;
      const years = [];
      for (let y = maxYear; y >= from; y--) years.push(y);
      return years.map(y => `<option value="${y}">${y}</option>`).join("");
    }

    function buildMonthOptions() {
      const months = [
        "January","February","March","April","May","June",
        "July","August","September","October","November","December"
      ];
      return months.map((m, i) => `<option value="${i+1}">${m}</option>`).join("");
    }

    // === REPORT HANDLERS ===
    function openContainer() {
      setSheetHeader("Bericht", L("hintContainer"), "Bericht");
      setSegments([], "", () => {});

      setForm(`
        <div class="field">
          <label>${L("year")}</label>
          <select id="reportYear">${buildYearOptions(2025, 2030)}</select>
        </div>
        <div class="field">
          <label>${L("week")}</label>
          <select id="reportWeek">${buildWeekOptions()}</select>
        </div>
      `);
      setNote("");

      const now = new Date();
      const yearEl = $("reportYear");
      const weekEl = $("reportWeek");
      if (yearEl) {
        const currentIsoYear = getISOYear(now);
        const clampedYear = Math.max(2025, Math.min(2030, currentIsoYear));
        yearEl.value = String(clampedYear);
      }
      if (weekEl) weekEl.value = String(getISOWeek(now));

      $("btnPrimary").textContent = L("generate");
      $("btnPrimary").onclick = async () => {
        const year = Number($("reportYear").value);
        const week = Number($("reportWeek").value);
        if (!Number.isFinite(year) || !Number.isFinite(week) || year < 2025 || year > 2030 || week < 1 || week > 53) {
          haptic("error");
          showToast("Invalid year/week");
          return;
        }
        await sendReportGenerate("bericht", { year, week });
      };

      openSheet();
    }

    function openDataPlan() {
      setSheetHeader("Data/Plan", L("hintDataPlan"), "Action");
      setSegments([], "", () => {});
      setForm(`
        <div class="note">
          ${L("hintDataPlan")}<br>
          <strong>Plan aktualisiere</strong>
        </div>
      `);
      setNote("");

      $("btnPrimary").textContent = "Plan aktualisiere";
      $("btnPrimary").onclick = async () => {
        haptic("impact");
        const btn = $("btnPrimary");
        const prevText = btn.textContent;
        btn.disabled = true;
        try {
          await requestPlanUpdate();
          haptic("success");
          showToast(L("toastPlanUpdateSent"));
          closeSheet();
          return;
        } catch (apiErr) {
          const ok = sendToBot({
            action: "plan_update",
            source: "miniapp",
            ts: Date.now(),
          });
          if (ok) {
            haptic("success");
            showToast(L("toastPlanUpdateSent"));
            closeSheet();
            return;
          }
          haptic("error");
          showToast(apiErr?.message || L("toastPlanUpdateNotSupported"));
        } finally {
          btn.disabled = false;
          btn.textContent = prevText;
        }
      };

      openSheet();
    }

    function openLkw() {
      let active = "mileage";
      const tabs = [
        { key:"mileage", label: L("tabMileage") },
        { key:"repair", label: L("tabRepair") },
      ];

      const render = () => {
        setSheetHeader("LKW", L("hintLkw"), "Params");
        setSegments(tabs, active, (k) => { active = k; render(); });

        if (active === "mileage") {
          setForm(`
            <div class="field">
              <label>${L("vehicle")}</label>
              <select id="lkwVehicle">${optionsFrom(DEMO_VEHICLES, L("choose"))}</select>
            </div>
            <div class="field">
              <label>${L("period")}</label>
              <select id="lkwPeriod">
                <option value="year">${L("year")}</option>
                <option value="all">${L("allTime")}</option>
              </select>
            </div>
            <div class="field" id="lkwYearBox">
              <label>${L("year")}</label>
              <select id="lkwYear">${buildYearOptions(2018)}</select>
            </div>
          `);
          setNote("");

          const period = $("lkwPeriod");
          const yearBox = $("lkwYearBox");
          period.onchange = () => {
            yearBox.style.display = (period.value === "year") ? "block" : "none";
          };

          $("btnPrimary").textContent = L("generate");
          $("btnPrimary").onclick = () => {
            const v = $("lkwVehicle").value;
            const p = $("lkwPeriod").value;
            const y = (p === "year") ? Number($("lkwYear").value) : null;
            if (!v) return haptic("error");
            sendToBot({ action:"report", report:"lkw_mileage", vehicle:v, period:p, year:y });
          };
        } else {
          setForm(`
            <div class="field">
              <label>${L("vehicle")}</label>
              <select id="repVehicle">${optionsFrom(DEMO_VEHICLES, L("choose"))}</select>
            </div>
            <div class="field">
              <label>${L("period")}</label>
              <select id="repPeriod">
                <option value="year">${L("year")}</option>
                <option value="all">${L("allTime")}</option>
              </select>
            </div>
            <div class="field" id="repYearBox">
              <label>${L("year")}</label>
              <select id="repYear">${buildYearOptions(2018)}</select>
            </div>
          `);
          setNote("");

          const period = $("repPeriod");
          const yearBox = $("repYearBox");
          period.onchange = () => {
            yearBox.style.display = (period.value === "year") ? "block" : "none";
          };

          $("btnPrimary").textContent = L("generate");
          $("btnPrimary").onclick = () => {
            const v = $("repVehicle").value;
            const p = $("repPeriod").value;
            const y = (p === "year") ? Number($("repYear").value) : null;
            if (!v) return haptic("error");
            sendToBot({ action:"report", report:"lkw_repair", vehicle:v, period:p, year:y });
          };
        }
      };

      render();
      openSheet();
    }

    function openFahrer() {
      let active = "data";
      const tabs = [
        { key:"data", label: L("tabDriverData") },
        { key:"urlaub", label: L("tabUrlaub") },
      ];

      const render = () => {
        setSheetHeader("Fahrer", L("hintFahrer"), "Params");
        setSegments(tabs, active, (k) => { active = k; render(); });

        setForm(`
          <div class="field">
            <label>${L("driver")}</label>
            <select id="driverSel">${optionsFrom(DEMO_DRIVERS, L("choose"))}</select>
          </div>
        `);
        setNote("");

        $("btnPrimary").textContent = L("send");
        $("btnPrimary").onclick = () => {
          const d = $("driverSel").value;
          if (!d) return haptic("error");
          sendToBot({
            action:"report",
            report: active === "data" ? "fahrer_data" : "fahrer_urlaub",
            driver: d
          });
        };
      };

      render();
      openSheet();
    }

    function openYf() {
      setSheetHeader("Yellow Fox", L("hintYf"), "Params");
      setSegments([], "", () => {});
      setForm(`
        <div class="field">
          <label>${L("vehicle")}</label>
          <select id="yfVehicle">${optionsFrom(DEMO_VEHICLES, L("choose"))}</select>
        </div>
        <div class="field">
          <label>${L("period")}</label>
          <select id="yfPeriod">
            <option value="week">Last 7 days</option>
            <option value="month">This month</option>
            <option value="last_month">Last month</option>
            <option value="custom">Custom range</option>
          </select>
        </div>
        <div id="yfCustom" style="display:none;">
          <div class="field">
            <label>From</label>
            <input id="yfFrom" type="date" />
          </div>
          <div class="field">
            <label>To</label>
            <input id="yfTo" type="date" />
          </div>
        </div>
      `);
      setNote("");

      const period = $("yfPeriod");
      const custom = $("yfCustom");
      period.onchange = () => { custom.style.display = (period.value === "custom") ? "block" : "none"; };

      $("btnPrimary").textContent = L("send");
      $("btnPrimary").onclick = () => {
        const v = $("yfVehicle").value;
        const p = $("yfPeriod").value;
        const from = $("yfFrom")?.value || null;
        const to = $("yfTo")?.value || null;
        if (!v) return haptic("error");
        if (p === "custom" && (!from || !to)) return haptic("error");
        sendToBot({ action:"report", report:"yf_mileage", vehicle:v, period:p, from, to });
      };

      openSheet();
    }

    function openEinnahmen() {
      setSheetHeader("Einnahmen", L("hintEinnahmen"), "Quick");
      setSegments([], "", () => {});
      setForm(`<div class="note">${L("hintEinnahmen")}</div>`);
      setNote("");
      $("btnPrimary").textContent = L("send");
      $("btnPrimary").onclick = () => sendToBot({ action:"report", report:"einnahmen_gesamt" });
      openSheet();
    }

    function openBonus() {
      let active = "current";
      const tabs = [
        { key:"current", label: "Current month" },
        { key:"month", label: "Choose month" },
        { key:"year", label: "Year" },
      ];

      const render = () => {
        setSheetHeader("Bonus", L("hintBonus"), "Quick/Params");
        setSegments(tabs, active, (k) => { active = k; render(); });

        if (active === "current") {
          setForm(`<div class="note">${L("hintBonus")}</div>`);
          setNote("");
          $("btnPrimary").textContent = L("send");
          $("btnPrimary").onclick = () => sendToBot({ action:"report", report:"bonus_current_month" });
          return;
        }

        if (active === "month") {
          setForm(`
            <div class="field">
              <label>${L("year")}</label>
              <select id="bYear">${buildYearOptions(2020)}</select>
            </div>
            <div class="field">
              <label>${L("month")}</label>
              <select id="bMonth">${buildMonthOptions()}</select>
            </div>
          `);
          setNote("");
          $("btnPrimary").textContent = L("send");
          $("btnPrimary").onclick = () => {
            const y = Number($("bYear").value);
            const m = Number($("bMonth").value);
            sendToBot({ action:"report", report:"bonus_month", year:y, month:m });
          };
          return;
        }

        setForm(`
          <div class="field">
            <label>${L("year")}</label>
            <select id="bYear2">${buildYearOptions(2020)}</select>
          </div>
        `);
        setNote("");
        $("btnPrimary").textContent = L("send");
        $("btnPrimary").onclick = () => {
          const y = Number($("bYear2").value);
          sendToBot({ action:"report", report:"bonus_year", year:y });
        };
      };

      render();
      openSheet();
    }

    // === INIT ===
    function wireMenu() {
      const comingSoon = () => {
        haptic("impact");
        showToast(L("toastComingSoon"));
      };
      const map = {
        container: openContainer,
        "data-plan": openDataPlan,
        lkw: comingSoon,
        fahrer: comingSoon,
        yf: comingSoon,
        einnahmen: comingSoon,
        bonus: comingSoon
      };

      document.querySelectorAll(".tile").forEach(tile => {
        tile.onclick = () => {
          const key = tile.getAttribute("data-report");
          map[key]?.();
        };
      });
    }

    function wireDock() {
      const labels = {
        history: L("navHistory"),
        "lkw-list": L("navLkwList"),
        "drivers-list": L("navDriversList"),
        "fuel-cards": L("navFuelCards"),
      };

      $("dock-history-label").textContent = labels.history;
      $("dock-lkw-label").textContent = labels["lkw-list"];
      $("dock-drivers-label").textContent = labels["drivers-list"];
      $("dock-fuel-label").textContent = labels["fuel-cards"];

      const handlers = {
        history: () => openHistory(),
        "lkw-list": () => openDockPdf("lkw-list", "lkwDockTitle"),
        "drivers-list": () => openDockPdf("drivers-list", "driversDockTitle"),
        "fuel-cards": () => openDockPdf("fuel-cards", "fuelDockTitle"),
      };

      document.querySelectorAll(".dock-item").forEach((item) => {
        item.onclick = () => {
          const key = item.getAttribute("data-dock");
          handlers[key]?.();
        };
      });
    }

    function wireTopActions() {
      const settingsBtn = $("btnSettings");
      const bellBtn = $("btnBell");
      if (settingsBtn) settingsBtn.onclick = showTelegramId;
      if (bellBtn) bellBtn.onclick = showEtlUpdates;
    }

    async function main() {
      // Detect language
      currentLang = detectLanguage();
      
      // Update UI text
      $("sectionTitle").textContent = L("sectionTitle");
      initBackgroundMotion();
      
      await showIntroThenApp();

      // Init Telegram WebApp
      try {
        Telegram?.WebApp?.ready?.();
        Telegram?.WebApp?.expand?.();
        Telegram?.WebApp?.enableClosingConfirmation?.();
      } catch {}

      const ctx = getTgContext();
      const user = ctx.user || {};
      const name = user.first_name || user.username || "User";

      await setAvatarFromTelegram(user, name, ctx.initData);
      $("welcomeTitle").textContent = `${L("welcome")}`;
      $("welcomeSub").textContent = `${name}`.trim();
      $("sectionBrand").innerHTML = "GROO&nbsp;&nbsp;GmbH";

      // Access check
      $("accessMsg").textContent = L("checking");
      $("accessBadge").textContent = "...";
      $("accessIcon").innerHTML = '<img src="icons/lock.svg" alt="" width="20" height="20">';

      const access = await checkAccessServer();
      if (access.state === "ok") {
        $("accessMsg").textContent = L("accessOk");
        $("accessBadge").textContent = L("ok");
        $("accessBadge").className = "badge ok";
        $("accessIcon").innerHTML = '<img src="icons/check.svg" alt="" width="20" height="20">';
        $("menu").classList.remove("disabled");
      } else if (access.state === "denied") {
        $("accessMsg").textContent = L("accessNo", ADMIN);
        $("accessBadge").textContent = L("no");
        $("accessBadge").className = "badge no";
        $("accessIcon").innerHTML = '<img src="icons/close.svg" alt="" width="20" height="20">';
        $("menu").classList.add("disabled");
      } else {
        $("accessMsg").textContent = L("accessApiPending");
        $("accessBadge").textContent = L("pending");
        $("accessBadge").className = "badge";
        $("accessIcon").innerHTML = '<img src="icons/lock.svg" alt="" width="20" height="20">';
        $("menu").classList.remove("disabled");
      }

      // Wire events
      $("btnClose").onclick = closeSheet;
      $("sheet").onclick = (e) => { 
        if (e.target === $("sheet")) closeSheet(); 
      };

      wireMenu();
      wireDock();
      wireTopActions();
    }

    main();
  </script>
</body>
</html>
